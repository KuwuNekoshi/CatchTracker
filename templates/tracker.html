<!doctype html>
<html>
  <head>
    <title>Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  </head>
  <body>
    <h1>{{ state.generation }} - {{ state.game }}</h1>
    <button id="theme-toggle"></button>
    <p>Current: <strong>{{ pokemon.name }}</strong> ({{ pokemon.location }})</p>
    <p>Status: {% if caught %}Caught{% else %}Not caught{% endif %}</p>
    <form method="post">
      <input type="hidden" name="sort" value="{{ sort }}">
      <button name="action" value="prev">Prev</button>
      <button name="action" value="toggle">{% if caught %}Unmark{% else %}Mark Caught{% endif %}</button>
      <button name="action" value="next">Next</button>
    </form>
    <p><a href="{{ url_for('select') }}">Change game</a></p>
    <p><a href="{{ url_for('display') }}" target="_blank">Open display</a></p>
    <input type="text" id="search" placeholder="Search PokÃ©mon">
    <form method="get" id="sort-form">
      <label for="sort">Sort:</label>
      <select name="sort" id="sort" onchange="this.form.submit()">
        <option value="catch" {% if sort == 'catch' %}selected{% endif %}>Catch Order</option>
        <option value="dex" {% if sort == 'dex' %}selected{% endif %}>Dex Order</option>
      </select>
    </form>
    <table id="dex-table">
      <thead>
        <tr>
          <th>DexID</th>
          <th>Sprite</th>
          <th>Name</th>
          <th>Generation(s)</th>
          <th>Game(s)</th>
          <th>Location</th>
        </tr>
      </thead>
      <tbody>
        <tr class="section"><th colspan="6">Uncaught</th></tr>
        {% for p in uncaught_list %}
        <tr data-name="{{ p.name | lower }}" data-id="{{ p.id }}" class="{% if p.id == pokemon.id %}current{% endif %}">
          <td>{{ '%03d'|format(p.id) }}</td>
          <td>{% if p.img_url %}<img src="{{ p.img_url }}" alt="{{ p.name }}">{% endif %}</td>
          <td>{{ p.name }}</td>
          <td>{{ ', '.join(p.generations) }}</td>
          <td>{{ ', '.join(p.games) }}</td>
          <td>{{ p.locations.get(state.game, '') }}</td>
        </tr>
        {% endfor %}
        <tr class="section"><th colspan="6">Caught</th></tr>
        {% for p in caught_list %}
        <tr data-name="{{ p.name | lower }}" data-id="{{ p.id }}" class="caught{% if p.id == pokemon.id %} current{% endif %}">
          <td>{{ '%03d'|format(p.id) }}</td>
          <td>{% if p.img_url %}<img src="{{ p.img_url }}" alt="{{ p.name }}">{% endif %}</td>
          <td>{{ p.name }}</td>
          <td>{{ ', '.join(p.generations) }}</td>
          <td>{{ ', '.join(p.games) }}</td>
          <td>{{ p.locations.get(state.game, '') }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <script src="{{ url_for('static', filename='theme.js') }}"></script>
    <script>
      const search = document.getElementById('search');
      search.addEventListener('input', function () {
        const term = this.value.toLowerCase();
        document.querySelectorAll('#dex-table tbody tr').forEach(tr => {
          if (tr.classList.contains('section')) return;
          tr.style.display = tr.dataset.name.includes(term) ? '' : 'none';
        });
      });
      document.querySelectorAll('#dex-table tbody tr').forEach(tr => {
        if (tr.classList.contains('section')) return;
        tr.addEventListener('click', function () {
          const id = this.dataset.id;
          fetch("{{ url_for('set_current') }}", {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({id: id})
          }).then(() => location.reload());
        });
      });
    </script>
  </body>
</html>

